<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AVD Control Service</title>
<style>
  #auth-buttons button { margin-right: 10px; }
  #api-buttons button { margin-right: 10px; margin-top: 10px; }
  #output { margin-top: 20px; font-family: Arial, sans-serif; }
  .error { color: red; font-weight: bold; }
  .success { color: green; font-weight: bold; }
</style>
</head>
<body>
<h1>AVD Control Service</h1>

<div id="auth-buttons">
  <button id="login-btn">Login</button>
  <button id="logout-btn">Logout</button>
</div>

<div id="api-buttons"></div>

<div id="output"></div>

<script>
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const apiButtonsDiv = document.getElementById("api-buttons");
const outputEl = document.getElementById("output");

loginBtn.addEventListener("click", () => window.location.href = "/.auth/login/aad");
logoutBtn.addEventListener("click", () => window.location.href = "/.auth/logout");

const apiRoutes = [
  { endpoint: "avd-start", label: "Start AVD" },
  { endpoint: "avd-status", label: "Check Status" },
  { endpoint: "avd-stop", label: "Stop AVD" }
];

async function checkAuth() {
  try {
    const res = await fetch('/.auth/me', { credentials: 'same-origin' });
    const data = await res.json();

    if (Array.isArray(data) && data.length > 0) {
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';

      const userRoles = data[0].userRoles || [];
      const userGroups = (data[0].userClaims || [])
        .filter(c => c.typ === "groups")
        .map(c => c.val);

      const allowedRoles = ["AVD_Users"];
      const allowedGroups = ["570fe125-3503-4277-8757-65f55a9ba35f"];

      const hasAccess = userRoles.some(r => allowedRoles.includes(r)) ||
                        userGroups.some(g => allowedGroups.includes(g));

      apiButtonsDiv.innerHTML = "";
      apiRoutes.forEach(r => {
        const btn = document.createElement("button");
        btn.textContent = r.label;
        btn.disabled = !hasAccess;
        btn.addEventListener("click", () => callApi(r.endpoint));
        apiButtonsDiv.appendChild(btn);
      });

      if (hasAccess) {
        outputEl.innerHTML = `<div class="success">‚úÖ Logged in as ${data[0].userId}</div>`;
      } else {
        outputEl.innerHTML = `<div class="error">üö´ You do not have permission to access AVD functions.</div>`;
      }

      console.log("Roles:", userRoles, "Groups:", userGroups);

    } else {
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      apiButtonsDiv.innerHTML = "";
      outputEl.innerHTML = `<div>Please log in to use the app.</div>`;
    }
  } catch (err) {
    console.error(err);
    outputEl.innerHTML = `<div class="error">‚ö†Ô∏è Error checking authentication: ${err.message}</div>`;
  }
}

async function callApi(endpoint, method = "GET", body = null) {
  try {
    const opts = { method, credentials: 'same-origin', headers: { 'Accept': 'application/json' } };
    if (body != null) {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(body);
    }

    const res = await fetch(`/api/${endpoint}`, opts);
    if (res.redirected && res.url.includes('/.auth/login')) {
      window.location.href = res.url;
      return;
    }

    const contentType = (res.headers.get("content-type") || "").toLowerCase();
    const isJson = contentType.includes("application/json");
    const data = isJson ? await res.json() : { error: "Unexpected response" };

    if (res.status === 401) { window.location.href = "/.auth/login/aad"; return; }
    if (res.status === 403) { outputEl.innerHTML = `<div class="error">üö´ Access Denied</div>`; return; }
    if (!res.ok) throw new Error(data?.error || "Unknown API error");

    outputEl.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    return data;
  } catch (err) {
    outputEl.innerHTML = `<div class="error">‚ö†Ô∏è Error</div><div>${err.message}</div>`;
  }
}

checkAuth();
</script>
</body>
</html>
