<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Azure VM Control Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    h1 { margin-bottom: 5px; }
    #vmStatus { font-size: 20px; font-weight: bold; padding: 5px 10px; border-radius: 6px; display: inline-block; }
    #lastUpdated { font-size: 14px; color: #666; margin-top: 5px; }
    button { padding: 10px 20px; margin: 10px 10px 0 0; cursor: pointer; font-size: 16px; border: none; border-radius: 5px; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .green { background: #d4edda; color: #155724; }
    .red { background: #f8d7da; color: #721c24; }
    .orange { background: #fff3cd; color: #856404; }
    .gray { background: #e2e3e5; color: #383d41; }
    .btn-green { background: #28a745; color: white; }
    .btn-red { background: #dc3545; color: white; }
    nav a { margin-right: 10px; }
  </style>
</head>
<body>
  <h1>Azure VM Control</h1>
  <div id="vmStatus" class="gray">Checking VM status...</div>
  <div id="lastUpdated">Last updated: --:--:--</div>

  <nav style="margin-top: 10px;">
    <span id="userInfo"></span>
    <a id="loginLink" href="/.auth/login/aad?post_login_redirect_uri=/">Login</a>
    <a id="logoutLink" href="/.auth/logout?post_logout_redirect_uri=/">Logout</a>
  </nav>

  <div id="controls" style="display:none;">
    <button id="startBtn" class="btn-green" onclick="startAvd()">Start VM</button>
    <button id="stopBtn" class="btn-red" onclick="stopAvd()">Stop VM</button>
  </div>

  <script>
    // Replace with your Entra group Object IDs (safe to expose)
    const AVD_USERS_GROUP_ID = "570fe125-3503-4277-8757-65f55a9ba35f";
    const AVD_ADMINS_GROUP_ID = "08160b89-cbf1-4e7b-bb51-f243c61e9cd0";

    let pollTimer;

    function updateTimestamp() {
      const now = new Date();
      document.getElementById("lastUpdated").innerText = `Last updated: ${now.toLocaleTimeString()}`;
    }

    async function safeJson(res) {
      const ct = res.headers.get("content-type") || "";
      if (ct.includes("application/json")) return res.json();
      return null; // Avoid "<!DOCTYPE" parse errors
    }

    async function callApi(endpoint, method = "GET") {
      try {
        const res = await fetch(`/api/${endpoint}`, { method });
        if (!res.ok) {
          // If SWA redirected to login, res is likely HTML; return a consistent error
          const data = await safeJson(res);
          const details = data && !data.success ? (data.error || JSON.stringify(data)) : `HTTP ${res.status}`;
          throw new Error(details);
        }
        const data = await res.json();
        return data;
      } catch (err) {
        return { success: false, error: err.message || "Request failed" };
      }
    }

    function setStatus(message, colorClass) {
      const statusEl = document.getElementById("vmStatus");
      statusEl.innerText = message;
      statusEl.className = colorClass;
      updateTimestamp();
    }

    function scheduleNextPoll(ms) {
      clearTimeout(pollTimer);
      pollTimer = setTimeout(updateStatus, ms);
    }

    async function updateStatus() {
      const data = await callApi("avd-status");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");

      if (data.success) {
        const state = (data.powerState || "").toLowerCase();

        if (state.includes("running")) {
          setStatus(data.powerState, "green");
          startBtn.disabled = true;
          stopBtn.disabled = false;
          scheduleNextPoll(10000);
        } else if (state.includes("deallocated")) {
          setStatus(data.powerState, "red");
          startBtn.disabled = false;
          stopBtn.disabled = true;
          scheduleNextPoll(10000);
        } else {
          setStatus(data.powerState, "orange");
          startBtn.disabled = true;
          stopBtn.disabled = true;
          scheduleNextPoll(3000);
        }
      } else {
        setStatus(`Error: ${data.error}`, "gray");
        scheduleNextPoll(15000);
      }
    }

    async function startAvd() {
      setStatus("Starting VM...", "orange");
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = true;
      await callApi("avd-start", "POST");
      scheduleNextPoll(3000);
    }

    async function stopAvd() {
      setStatus("Stopping VM...", "orange");
      document.getElementById("startBtn").disabled = true;
      document.getElementById("stopBtn").disabled = true;
      const res = await callApi("avd-stop", "POST");
      if (!res.success && /403/.test(res.error)) {
        alert("You are signed in but not allowed to stop the VM.");
      }
      scheduleNextPoll(3000);
    }

    function groupsFromAuthMe(meJson) {
      const set = new Set();
      const claims = meJson?.clientPrincipal?.claims || [];
      for (const c of claims) {
        if (c?.typ === "groups" || c?.typ === "http://schemas.microsoft.com/ws/2008/06/identity/claims/groups") {
          set.add(c.val);
        }
      }
      return set;
    }

    async function toggleAuthLinks() {
      try {
        const res = await fetch("/.auth/me", { headers: { "Cache-Control": "no-store" } });
        const data = await safeJson(res);
        const principal = data?.clientPrincipal || null;

        const loginLink = document.getElementById("loginLink");
        const logoutLink = document.getElementById("logoutLink");
        const userInfo = document.getElementById("userInfo");
        const controls = document.getElementById("controls");
        const stopBtn = document.getElementById("stopBtn");

        if (!principal) {
          userInfo.textContent = "";
          loginLink.style.display = "inline";
          logoutLink.style.display = "none";
          controls.style.display = "none";
          return;
        }

        userInfo.textContent = `Signed in as ${principal.userDetails || principal.identityProvider}`;
        loginLink.style.display = "none";
        logoutLink.style.display = "inline";

        // Show controls for all authenticated users (API still enforces)
        controls.style.display = "block";

        // Optionally hide Stop for non-admins when group claim present
        const gs = groupsFromAuthMe(data);
        const isAdmin = gs.has(AVD_ADMINS_GROUP_ID);
        stopBtn.style.display = isAdmin ? "inline-block" : "none";

      } catch {
        // If anything fails, show login
        document.getElementById("loginLink").style.display = "inline";
        document.getElementById("logoutLink").style.display = "none";
        document.getElementById("controls").style.display = "none";
      }
    }

    // Live clock
    setInterval(updateTimestamp, 1000);

    // Bootstrap
    toggleAuthLinks();
    updateStatus();
  </script>
</body>
</html>
