<script>
const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const startBtn = document.getElementById("start-btn");
const stopBtn = document.getElementById("stop-btn");
const statusBtn = document.getElementById("status-btn");
const outputEl = document.getElementById("output");

// Redirect to login/logout
loginBtn.addEventListener("click", () => window.location.href = "/.auth/login/aad");
logoutBtn.addEventListener("click", () => window.location.href = "/.auth/logout");

// Check login state and roles
async function checkAuth() {
  try {
    const res = await fetch('/.auth/me', { credentials: 'same-origin' });
    const data = await res.json();

    if (Array.isArray(data) && data.length > 0) {
      // User is signed in
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';

      const userRoles = data[0].userRoles || [];

      // Disable all buttons by default
      startBtn.disabled = true;
      stopBtn.disabled = true;
      statusBtn.disabled = true;

      // Allow based on roles
      if (userRoles.includes("AVD_Users")) {
        startBtn.disabled = false;
        statusBtn.disabled = false;
      }
      if (userRoles.includes("AVD_Administrators")) {
        stopBtn.disabled = false;
        statusBtn.disabled = false; // Admins can also check status
      }

      outputEl.innerHTML = `<div class="success">✅ Logged in as ${data[0].userId}</div>`;
      console.log("Roles:", userRoles);
    } else {
      // Not signed in
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
      startBtn.disabled = true;
      stopBtn.disabled = true;
      statusBtn.disabled = true;
      outputEl.innerHTML = `<div>Please log in to use the app.</div>`;
    }
  } catch (err) {
    console.error(err);
    outputEl.innerHTML = `<div class="error">⚠️ Error checking authentication: ${err.message}</div>`;
  }
}

// Call API helper
async function callApi(endpoint, method = "GET", body = null) {
  try {
    const opts = {
      method,
      credentials: 'same-origin',
      headers: { 'Accept': 'application/json' }
    };

    if (body != null) {
      opts.headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(body);
    }

    const res = await fetch(`/api/avd/${endpoint}`, opts);

    const contentType = (res.headers.get("content-type") || "").toLowerCase();
    const isJson = contentType.includes("application/json");
    const data = isJson ? await res.json() : { error: "Unexpected response" };

    if (!res.ok) throw new Error(data?.error || "Unknown API error");

    outputEl.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    return data;
  } catch (err) {
    outputEl.innerHTML = `<div class="error">⚠️ Error: ${err.message}</div>`;
  }
}

// Hook up buttons
startBtn.addEventListener("click", () => callApi("start", "POST"));
stopBtn.addEventListener("click", () => callApi("stop", "POST"));
statusBtn.addEventListener("click", () => callApi("status", "GET"));

// Run auth check on load
checkAuth();
</script>
