<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AVD Control</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #message { margin-bottom: 1rem; display: none; }
    #message.error { color: red; }
    #message.success { color: green; }
    button { margin-right: .5rem; }
  </style>
</head>
<body>
  <div id="message"></div>

  <button id="loginBtn">Log In</button>
  <button id="logoutBtn" style="display:none;">Log Out</button>
  <button id="statusBtn" disabled>Get Status</button>
  <button id="startBtn"  disabled>Start AVD</button>
  <button id="stopBtn"   disabled>Stop AVD</button>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const msg       = document.getElementById('message');
      const loginBtn  = document.getElementById('loginBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const statusBtn = document.getElementById('statusBtn');
      const startBtn  = document.getElementById('startBtn');
      const stopBtn   = document.getElementById('stopBtn');

      function show(text, type = '') {
        msg.textContent   = text;
        msg.className     = type;
        msg.style.display = 'block';
      }

      function setButtons({ isUser, isAdmin }) {
        statusBtn.disabled = !(isUser || isAdmin);
        startBtn.disabled  = !(isUser || isAdmin);
        stopBtn.disabled   = !isAdmin;
      }

      loginBtn.addEventListener('click', () => {
        window.location.href = '/.auth/login/aad?post_login_redirect_uri=/';
      });
      logoutBtn.addEventListener('click', () => {
        window.location.href = '/.auth/logout?post_logout_redirect_uri=/';
      });

      async function callApi(path, method = 'GET') {
        show('Loading…');
        const res = await fetch(`/api/avd/${path}`, {
          method, credentials: 'same-origin'
        });
        const txt = await res.text();
        let data;
        try { data = JSON.parse(txt); } catch { data = txt; }
        if (!res.ok) {
          const err = data?.error || txt || `HTTP ${res.status}`;
          show(err, 'error');
          throw new Error(err);
        }
        return data;
      }

      statusBtn.addEventListener('click', async () => {
        try {
          const { result } = await callApi('status');
          show(`VM status: ${result}`, 'success');
        } catch {}
      });

      startBtn.addEventListener('click', async () => {
        try {
          await callApi('start', 'POST');
          show('AVD starting…', 'success');
        } catch {}
      });

      stopBtn.addEventListener('click', async () => {
        try {
          await callApi('stop', 'POST');
          show('AVD stopping…', 'success');
        } catch {}
      });

      async function checkAuth() {
        try {
          const res = await fetch('/.auth/me', { credentials: 'same-origin' });
          if (res.redirected) {
            show('Please log in to use the app.', 'error');
            return;
          }
          const { clientPrincipal: principal } = await res.json();
          if (!principal) {
            show('Please log in to use the app.', 'error');
            return;
          }

          console.log('Principal:', principal);
          loginBtn.style.display  = 'none';
          logoutBtn.style.display = 'inline-block';
          show(`✅ Logged in as ${principal.userDetails}`, 'success');

          const roles = (principal.userRoles || [])
                          .map(r => r.toLowerCase());
          console.log('Roles:', roles);

          setButtons({
            isUser:  roles.includes('user'),
            isAdmin: roles.includes('admin')
          });
        } catch (err) {
          console.error(err);
          show('Auth check error—see console.', 'error');
        }
      }

      checkAuth();
    });
  </script>
</body>
</html>
